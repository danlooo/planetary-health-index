reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
read_nc_features <- function(used_sphere, used_features) {
if (sphere == "socio") {
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
} else {
features |>
filter(sphere == used_sphere & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
}
}
source("~/prj/planetary-health-index/lib.R")
read_nc_features("bio", c("skt"))
read_nc_features <- function(used_sphere, used_features) {
if (used_sphere == "socio") {
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
} elseif(used_sphere %in% c("bio", "atmo")) {
read_nc_features <- function(used_sphere, used_features) {
if (used_sphere == "socio") {
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
} else if(used_sphere %in% c("bio", "atmo")) {
features |>
filter(sphere == used_sphere & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
}
stop("Sphere not implemented")
}
features
features <- bind_rows(
tibble(
sphere = "atmo",
var_id = c("ssr", "vpd", "tp", "sp", "v10", "u10", "t2m")
) |>
mutate(label = var_id, path = "data/level_3_quarter.nc"),
tribble(
~var_id, ~label,
"Day_AQUA_Mxx21x1_061_gapfilled_QCflags_dyn", "Day water Mxx",
"Night_AQUA_Mxx21x1_061_gapfilled_QCflags_dyn", "Night water Mxx",
"NDWI_band7gapfilled_061_QCdyn", "NDWI",
"NDVIgapfilled_061_QCdyn", "NDVI",
"NIRvgapfilled_061_QCdyn", "NIRv",
"NEE", "NEE",
"H", "H",
"ET", "ET",
"ET_T", "ET_T",
"GPP", "GPP",
"skt", "skt"
) |>
mutate(sphere = "bio", path = "data/level_3_quarter.nc"),
tribble(
~path, ~var_id, ~label,
"data/eurostat-nc/demo_r_d3dens.nc", "demo_r_d3dens", "Pop density",
"data/eurostat-nc/nama_10r_3gdp.nc", "nama_10r_3gdp", "GDP",
# read_nc_feature_socio("phi-eu/data/eurostat-nc/nama_10r_2gvagr.nc", "nama_10r_2gvagr_B1G"),
# read_nc_feature_socio("phi-eu/data/eurostat-nc/nama_10r_2gvagr.nc", "nama_10r_2gvagr_B1GQ"),
# files not found
# read_nc_feature_socio("data/eurostat-nc/prc_hicp_midx.nc", "prc_hicp_midx_FOOD", "Food_Price"),
# read_nc_feature_socio("data/eurostat-nc/prc_hicp_midx.nc", "prc_hicp_midx_FUEL", "Fuel_Price"),
# read_nc_feature_socio("data/eurostat-nc/prc_hicp_midx.nc", "prc_hicp_midx_ELC_GAS", "GAS_Price"),
"data/eurostat-nc/edat_lfse_04.nc", "edat_lfse_04_T_ED3-8_Y25-64", "Education",
"data/eurostat-nc/lfst_r_lfu3pers.nc", "lfst_r_lfu3pers_ED5-8_T_Y20-64", "Employement",
# read_nc_feature_socio("phi-eu/data/eurostat-nc/teicp250.nc", "teicp250_NRG"), # Energy # NO DATA
# read_nc_feature_socio("phi-eu/data/eurostat-nc/teicp010.nc", "teicp010_CP01"), # Food Price # NO DATA!
# read_nc_feature_socio("phi-eu/data/eurostat-nc/nama_10_nfa_bs.nc", "nama_10_nfa_bs_S12_N1173N"),
# read_nc_feature_socio("phi-eu/data/eurostat-nc/nama_10_nfa_bs.nc", "nama_10_nfa_bs_S11_N13N"),
"data/eurostat-nc/nama_10_nfa_bs.nc", "nama_10_nfa_bs_S13_N21ON", "Capital stock"
) |>
mutate(sphere = "socio")
)
features
debugSource("~/prj/planetary-health-index/lib.R")
runApp()
runApp()
atmo_df <-
features |>
filter(sphere == "atmo" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
used_features <- features$label
atmo_df <-
features |>
filter(sphere == "atmo" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
bio_df <-
features |>
filter(sphere == "bio" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
socio_df <-
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
# "inner join" spheres
observations <- intersect(socio_df$observation, atmo_df$observation)
observations <- intersect(observations, bio_df$observation)
prep_cca <- function(data) {
data |>
filter(observation %in% observations) |>
mutate(across(everything(), ~ replace_na(., 0))) |>
column_to_rownames("observation")
}
atmo_mat <- prep_cca(atmo_df)
bio_mat <- prep_cca(bio_df)
socio_mat <- prep_cca(socio_df)
socio_mat
bio_mat
bio_mat[1:2,1:3]
atmo_mat[1:2,1:3]
path = "data/eurostat-nc/demo_r_d3dens.nc"
nc <- nc_open(path)
mat <- ncvar_get(nc, var_id)
nc
var_id <- "demo_r_d3dens"
nc
ncvar_get(nc, var_id)
rownames(mat) <- nc$dim$time$vals
colnames(mat) <- nc$dim$country$vals
mat <- ncvar_get(nc, var_id)
rownames(mat) <- nc$dim$time$vals
colnames(mat) <- nc$dim$country$vals
mat
mat <- ncvar_get(nc, var_id)
rownames(mat) <- nc$dim$time$vals
colnames(mat) <- nc$dim$country$vals
as_tibble(mat)
matrix(data, nrow = rows, ncol = cols)
nc$dim$time$vals
rownames(mat) <- nc$dim$TIME_PERIOD$vals
colnames(mat) <- nc$dim$geo$vals
mat <- ncvar_get(nc, var_id)
rownames(mat) <- nc$dim$TIME_PERIOD$vals
colnames(mat) <- nc$dim$geo$vals
mat
mat[1:2,1:3]
bio_mat
atmo_df <-
features |>
filter(sphere == "atmo" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
bio_df <-
features |>
filter(sphere == "bio" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
socio_df <-
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
# "inner join" spheres
observations <- intersect(socio_df$observation, atmo_df$observation)
observations <- intersect(observations, bio_df$observation)
prep_cca <- function(data) {
data |>
filter(observation %in% observations) |>
mutate(across(everything(), ~ replace_na(., 0))) |>
column_to_rownames("observation")
}
atmo_mat <- prep_cca(atmo_df)
bio_mat <- prep_cca(bio_df)
socio_mat <- prep_cca(socio_df)
atmo_df <-
features |>
filter(sphere == "atmo" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
bio_df <-
features |>
filter(sphere == "bio" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
socio_df <-
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
# "inner join" spheres
observations <- intersect(socio_df$observation, atmo_df$observation)
observations <- intersect(observations, bio_df$observation)
prep_cca <- function(data) {
data |>
filter(observation %in% observations) |>
mutate(across(everything(), ~ replace_na(., 0))) |>
column_to_rownames("observation")
}
atmo_mat <- prep_cca(atmo_df)
bio_mat <- prep_cca(bio_df)
socio_mat <- prep_cca(socio_df)
ccas <- list(
"bio-socio" = stats::cancor(bio_mat, socio_mat),
"bio-atmo" = stats::cancor(bio_mat, atmo_mat),
"socio-bio" = stats::cancor(socio_mat, bio_mat),
"socio-atmo" = stats::cancor(socio_mat, atmo_mat),
"atmo-socio" = stats::cancor(atmo_mat, socio_mat),
"atmo-bio" = stats::cancor(atmo_mat, bio_mat)
)
ccas <- list(
"bio-socio" = stats::cancor(bio_mat, socio_mat),
"bio-atmo" = stats::cancor(bio_mat, atmo_mat),
"socio-bio" = stats::cancor(socio_mat, bio_mat),
"socio-atmo" = stats::cancor(socio_mat, atmo_mat),
"atmo-socio" = stats::cancor(atmo_mat, socio_mat),
"atmo-bio" = stats::cancor(atmo_mat, bio_mat)
)
ccas <- list(
"bio-socio" = stats::cancor(bio_mat, socio_mat),
"bio-atmo" = stats::cancor(bio_mat, atmo_mat),
"socio-bio" = stats::cancor(socio_mat, bio_mat),
"socio-atmo" = stats::cancor(socio_mat, atmo_mat),
"atmo-socio" = stats::cancor(atmo_mat, socio_mat),
"atmo-bio" = stats::cancor(atmo_mat, bio_mat)
)
ccas <- list(
"bio-socio" = stats::cancor(bio_mat, socio_mat),
"bio-atmo" = stats::cancor(bio_mat, atmo_mat),
"socio-bio" = stats::cancor(socio_mat, bio_mat),
"socio-atmo" = stats::cancor(socio_mat, atmo_mat),
"atmo-socio" = stats::cancor(atmo_mat, socio_mat),
"atmo-bio" = stats::cancor(atmo_mat, bio_mat)
)
library(profvis)
source("~/prj/planetary-health-index/lib.R")
library(shiny)
library(tidyverse)
library(bslib)
library(plotly)
library(ggsci)
library(targets)
library(shinycssloaders)
library(ncdf4)
source("lib.R")
nuts3_regions <- read_csv("data/nuts3_regions.csv")
withSpinner <- partial(shinycssloaders::withSpinner, color = primary_color, type = 8)
theme_set(
theme_classic(base_size = 18) + theme(
legend.position = "bottom"
)
)
features
features$var_id
calculate_ccas(features$var_id)
calculate_ccas(features$label)
calculate_ccas(features$label)
profvis(calculate_ccas(features$label))
runApp()
runApp()
runApp()
atmo_df <-
features |>
filter(sphere == "atmo" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
bio_df <-
features |>
filter(sphere == "bio" & label %in% used_features) |>
mutate(data = map(var_id, read_nc_feature_bioatmo)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
socio_df <-
features |>
filter(sphere == "socio" & label %in% used_features) |>
mutate(data = map2(path, var_id, read_nc_feature_socio)) |>
pull(data) |>
reduce(inner_join) |>
mutate(across(where(is.numeric), scale))
# "inner join" spheres
observations <- intersect(socio_df$observation, atmo_df$observation)
observations <- intersect(observations, bio_df$observation)
prep_cca <- function(data) {
data |>
filter(observation %in% observations) |>
mutate(across(everything(), ~ replace_na(., 0))) |>
column_to_rownames("observation")
}
atmo_mat <- prep_cca(atmo_df)
bio_mat <- prep_cca(bio_df)
socio_mat <- prep_cca(socio_df)
socio_mat
socio_mat[, c("demo_r_d3dens")]
used_features
features
runApp()
shiny::runApp()
library(profvis)
profvis(calculate_ccas(input$used_features))
profvis(calculate_ccas(c("skt", "sp")))
profvis(calculate_ccas(c("skt", "sp", "nama_10_nfa_bs_S13_N21ON")))
profvis(calculate_ccas(c("skt", "sp", "nama_10_nfa_bs_S13_N21ON")))
profvis(calculate_ccas(c("skt", "sp", "nama_10_nfa_bs_S13_N21ON", "Night_AQUA_Mxx21x1_061_gapfilled_QCflags_dyn")))
profvis(calculate_ccas(features$label))
profvis(calculate_ccas(features$label))
tar_make_clustermq()
tar_option_set(
controller = crew_controller_local(workers = 1),
error = "continue"
)
list(
tar_target(
name = eurostat_datasets,
command = {
get_eurostat_toc() |>
mutate(last.update.of.data = as.Date(last.update.of.data, format = "%d.%m.%Y")) %>%
filter(
type != "folder" &
last.update.of.data > as.Date("2020-01-01") &
values > 500 &
code %in% selected_codes
) |>
# enforce code to be unique
select(-hierarchy) |>
distinct(code, .keep_all = TRUE)
}
),
tar_target(
name = eurostat_files,
pattern = map(eurostat_datasets),
command = {
eurostat_datasets |>
transmute(
code,
path = map_chr(code, ~ {
# prevent data race on eurostat cache metadata json
data <- get_eurostat(.x, cache = FALSE)
path <- str_glue("out/eurostat-raw/{.x}.parquet")
write_parquet(data, path)
path
})
)
}
),
tar_target(eurostat_regions, tibble(
geo = eurostat_geodata_60_2016$geo,
nut_level = eurostat_geodata_60_2016$LEVL_CODE
)),
tar_target(
name = nuts3_regions,
command = {
eurostat_regions |>
filter(nut_level == 3) |>
transmute(
geo3 = geo,
geo2 = map_chr(geo3, ~ str_sub(.x, 1, 4)),
geo1 = map_chr(geo3, ~ str_sub(.x, 1, 3)),
geo0 = map_chr(geo3, ~ str_sub(.x, 1, 2)),
)
}
),
tar_target(
name = eurostat_metadata,
pattern = map(eurostat_files),
command = {
eurostat_files |>
mutate(data = map(path, ~ .x |> read_parquet())) |>
transmute(
code,
colnames = map(data, ~ .x |> colnames()),
freq = map_chr(data, ~ .x$freq[[1]]),
nut_level = map_dbl(data, ~ {
# infer nut_level by looking at first few rows
nut_level_count <-
.x |>
head(100) |>
distinct(geo) |>
inner_join(eurostat_regions, by = "geo") |>
count(nut_level) |>
arrange(-n)
if (nrow(nut_level_count) == 1) {
nut_level_count$nut_level[[1]]
} else {
# some datasets may have multiple nut levels
max(nut_level_count$nut_level)
}
}),
vars = map2_dbl(data, code, ~ {
var_columns <- setdiff(names(.x), stable_columns)
.x |>
mutate(code = .y) |>
unite(var, all_of(c("code", var_columns)), sep = "_", remove = TRUE) |>
group_by(var) |>
count() |>
nrow()
})
)
}
),
tar_target(
name = eurostat_cube_files,
pattern = map(eurostat_files),
command = {
eurostat_files |>
mutate(
data = map2(path, code, ~ {
read_parquet(.x) |>
# discard aggregated data
filter(!str_starts(geo, "EU|EA|EEA")) |> # e.g euro area
group_by(nut_level = nchar(geo) - 2) |>
nest() |>
arrange(-nut_level) |>
pull(data) |>
first() |>
# create variable
mutate(code = .y) |>
select(code, everything()) |>
unite(var, -any_of(setdiff(stable_columns, "code")), sep = "_") |>
# re-scale
resample_time_to_quarter() |>
resample_space_to_nuts3(nuts3_regions, eurostat_regions)
}),
path = str_glue("data/eurostat-nc/{code}.nc"),
out = map2_chr(data, path, write_nc_tibble)
) |>
select(-out)
}
)
)
tar_make()
tar_make()
tar_make()
tar_make()
tar_option_set(
controller = crew_controller_local(workers = 1),
error = "continue"
)
library(tidyverse)
library(targets)
library(crew)
library(eurostat)
library(arrow)
# load libs for cdf4
# dyn.load("/opt/ohpc/pub/libs/hwloc/lib/libhwloc.so.15")
# dyn.load("/opt/ohpc/pub/libs/gnu9/openmpi4/hdf5/1.10.8/lib/libhdf5_hl.so.100")
library(RNetCDF)
library(rrcov3way)
source("lib.R")
set.seed(1337)
tar_option_set(
controller = crew_controller_local(workers = 1),
error = "continue"
)
library(tidyverse)
library(targets)
library(crew)
library(eurostat)
library(arrow)
# load libs for cdf4
# dyn.load("/opt/ohpc/pub/libs/hwloc/lib/libhwloc.so.15")
# dyn.load("/opt/ohpc/pub/libs/gnu9/openmpi4/hdf5/1.10.8/lib/libhdf5_hl.so.100")
library(RNetCDF)
library(rrcov3way)
source("lib.R")
set.seed(1337)
tar_option_set(
controller = crew_controller_local(workers = 1),
error = "continue"
)
source("~/prj/planetary-health-index/_targets.R")
tar_make()
source("~/prj/planetary-health-index/_targets.R")
tar_make()
tar_make()
tar_make()
tar_make()
tar_make()
source("~/prj/planetary-health-index/_targets.R")
tar_make()
